import groovy.json.JsonSlurper
def initURI(){
    def jsonSlurper = new JsonSlurper()
    def filePath = "/var/jenkins_home/jobs/${env.JOB_NAME}/configure.json"
    //def filePath = "configure.json"
    def reader = new BufferedReader(new InputStreamReader(new FileInputStream("$filePath"),"UTF-8"))
    def configuration = jsonSlurper.parse(reader)
    assert configuration instanceof Map
    def uri = "$configuration.method $configuration.url"
    return  uri
}

def respondVerify(respondStr,msg){
    println(respondStr)
    def jsonSlurper = new JsonSlurper()
    def respondJson = jsonSlurper.parseText(respondStr)
    assert respondJson instanceof Map
    println("$respondJson.id")
    if(respondJson.status=="F"){
        msg=respondJson.message
        return false
    }
    msg=respondJson.message
    return true
}

pipeline {
    agent any
    stages{
        stage("Invoker") {
            steps{
                script{
                    def uri = initURI()
                    def re = sh (script: "curl -X ${uri}", returnStdout: true)
                    def msg = "UNKOWN"
                    def status = respondVerify("${re}",msg)
                    sh "echo ${status}: ${msg}"
                    if(status.equals(false)){
                        error "build fail"
                    }
                }
            }
        }
    }
    post {
        success{
            slackSend (color: '#33ff36', message: "Sucessed built: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]\nView Report: (${env.BUILD_URL})'")
        }
        failure {
            slackSend (color: '#33ff36', message: "Failed build:: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]\nView Report: (${env.BUILD_URL})'")
        }
    }
}
